# GitHub Actions デプロイマニュアル

このドキュメントでは、BulkSender-Frontプロジェクトのデプロイフローおよび関連するGitHub Actionsワークフローの実行方法について詳しく説明します。

## 目次

- [デプロイフロー概要](#デプロイフロー概要)
- [デプロイの実行方法](#デプロイの実行方法)
- [デプロイのカスタマイズ](#デプロイのカスタマイズ)
- [デプロイ成功の確認方法](#デプロイ成功の確認方法)
- [トラブルシューティング](#トラブルシューティング)
- [緊急時の対応](#緊急時の対応)

## デプロイフロー概要

BulkSender-Frontプロジェクトのデプロイフローは以下のステップで構成されています：

1. **コードのビルド**: プロジェクトのソースコードをビルドして、最適化された静的ファイルを生成
2. **AWS S3へのアップロード**: 生成された静的ファイルをS3バケットにアップロード
3. **CloudFrontキャッシュの無効化**: 変更されたコンテンツを即時に反映するために実行

このフローはすべて GitHub Actions によって自動化されています。

## デプロイの実行方法

### 手動デプロイの実行手順

1. GitHub リポジトリにアクセスします
2. 上部メニューから「Actions」タブをクリックします
3. 左サイドバーから「Build & Deploy」ワークフローを選択します
4. 右側の「Run workflow」ボタンをクリックします
5. 以下のパラメータを設定します：
   - **Use workflow from**: デプロイ元のブランチを選択（通常は `main` または `develop`）
   - **Select Environment**: デプロイ先の環境を選択（`production` または `staging`）
   - **Select App Path**: デプロイ先のパスを選択（必要に応じて）
6. 緑色の「Run workflow」ボタンをクリックして実行開始

![デプロイフロー実行画面](../../../assets/images/deploy-workflow.png)

### デプロイパラメータの詳細

| パラメータ | 説明 | 選択肢 |
|----------|------|-------|
| Use workflow from | デプロイするコードのソースブランチ | main, develop, feature/* など |
| Select Environment | デプロイ先の環境 | production, staging, demo |
| Select App Path | アプリケーションのデプロイパス | / (ルート), /app, /admin など |

## デプロイのカスタマイズ

### 環境変数の設定

デプロイ環境ごとに異なる環境変数を設定しています：

- 本番環境: `.env.production`
- ステージング環境: `.env.stg`
- デモ環境: `.env.demo`

必要に応じて、これらのファイルを編集してデプロイ前にコミットしてください。

### ビルドパラメータの変更

ビルドパラメータを変更する場合は、`.github/workflows/deploy.yml` ファイルを編集し、ビルドコマンドやその他のパラメータを調整してください。

```yaml
# ビルドコマンドの例
- name: Build application
  run: |
    npm ci
    npm run build -- --mode ${{ github.event.inputs.environment }}
```

## デプロイ成功の確認方法

1. GitHub Actionsのワークフロー実行ページで、すべてのステップが正常に完了したことを確認（緑色のチェックマーク）
2. デプロイされたURLにアクセスして、アプリケーションが正常に動作することを確認：
   - 本番環境: `https://app.example.com`
   - ステージング環境: `https://stg.example.com`
   - デモ環境: `https://demo.example.com`

3. 以下の項目を重点的にチェック：
   - ウェブページが正常に表示されるか
   - 主要な機能（ウォレット接続、送金シミュレーションなど）が動作するか
   - レイアウトやスタイルが崩れていないか

## トラブルシューティング

### デプロイ中のエラー

#### IAM関連のエラー
```
Error: Access denied or invalid credentials when accessing AWS resources
```

**解決策**:
- GitHubの設定で「Secrets and variables」→「Actions」を開き、AWS関連のシークレットが正しく設定されているか確認
- IAMユーザーに適切な権限が付与されているか確認
- IAMポリシーがS3バケットとCloudFrontディストリビューションに適切にアクセスできるよう設定されているか確認

#### ビルドエラー
```
Error: Build failed with exit code 1
```

**解決策**:
- ワークフローログでビルド失敗の原因を特定
- 依存関係の問題があれば、`package.json`を確認し必要な依存関係を追加
- 型エラーや構文エラーがあれば修正してから再度デプロイを実行

#### S3アップロードエラー
```
Error: Failed to upload files to S3 bucket
```

**解決策**:
- S3バケットが存在することを確認
- IAMユーザーがバケットへの書き込み権限を持っているか確認
- バケットポリシーやCORSの設定を確認

### その他のトラブルシューティング

- デプロイ後にウェブサイトが更新されない場合は、ブラウザのキャッシュをクリアしてみてください
- CloudFrontの無効化が完了するまで数分かかる場合があります
- Webhook通知が設定されている場合は、通知の内容を確認して詳細なエラー情報を入手してください

## 緊急時の対応

### デプロイ失敗時のロールバック手順

1. GitHubの「Actions」タブで過去の成功したデプロイを特定
2. 該当するコミットハッシュをメモ
3. 「Run workflow」から手動でデプロイを実行し、ソースブランチに代わりにコミットハッシュを指定

### 緊急時の連絡先

デプロイに関する緊急の問題がある場合は、以下の担当者に連絡してください：

- プロジェクト管理者: [管理者名] (example@example.com)
- インフラ担当: [担当者名] (infra@example.com)

---

このドキュメントは定期的に更新されます。最新の情報については、プロジェクト管理者にお問い合わせください。